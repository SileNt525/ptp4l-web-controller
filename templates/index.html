<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PTP Controller v3.1</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .status-box { padding: 15px; border-radius: 8px; color: white; height: 100%; display: flex; flex-direction: column; justify-content: center; }
        .bg-running { background-color: #198754; } 
        .bg-stopped { background-color: #dc3545; }
        .bg-slave { background-color: #0d6efd; }
        .bg-master { background-color: #6610f2; }
        .bg-init { background-color: #ffc107; color: black; }
        #logWindow { background-color: #212529; color: #0f0; height: 450px; overflow-y: auto; padding: 10px; font-family: monospace; font-size: 0.8rem; }
    </style>
</head>
<body class="bg-light">
<div class="container-fluid p-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3 class="mb-0">⏱️ PTP4L Controller <small class="text-muted fs-6">v3.1 (BC Support) by Vega Sun</small></h3>
        <span class="badge bg-secondary">{{ hostname }}</span>
    </div>

    <div class="row g-3 mb-3">
        <div class="col-md-4">
            <div id="ptpCard" class="status-box bg-stopped shadow-sm">
                <small>Device State</small>
                <div id="ptpState" class="h3 mb-0">STOPPED</div>
                <small id="serviceStateDetail" class="opacity-75">Service Inactive</small>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card h-100 p-3 shadow-sm justify-content-center">
                <small class="text-muted">Offset</small>
                <div id="offsetVal" class="h3 mb-0 text-primary">--</div>
                <small>ns</small>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card h-100 p-3 shadow-sm justify-content-center">
                <small class="text-muted">Grandmaster ID</small>
                <div id="gmId" class="h6 mb-0 text-break font-monospace">Scanning...</div>
            </div>
        </div>
    </div>

    <div class="row g-3">
        <div class="col-lg-4">
            <div class="card shadow-sm">
                <div class="card-header fw-bold">⚙️ Configuration</div>
                <div class="card-body">
                    <form id="configForm">
                        <div class="mb-3">
                            <label class="form-label fw-bold">Device Mode</label>
                            <select class="form-select" id="clockMode" onchange="toggleMode()">
                                <option value="OC" selected>Ordinary Clock (单口终端)</option>
                                <option value="BC">Boundary Clock (双口转发)</option>
                            </select>
                        </div>

                        <div id="ocPanel" class="mb-3">
                            <label class="small text-muted">Network Interface</label>
                            <select class="form-select" id="interface">
                                {% for nic in nics %}<option value="{{ nic }}">{{ nic }}</option>{% endfor %}
                            </select>
                        </div>

                        <div id="bcPanel" class="mb-3 border p-2 rounded bg-light" style="display:none;">
                            <label class="small fw-bold text-primary mb-2">Boundary Clock Settings</label>
                            
                            <div class="mb-2">
                                <label class="small text-muted">⬇️ Upstream (接收来自 GM)</label>
                                <select class="form-select form-select-sm" id="bcSlaveIf">
                                    <option value="" disabled selected>Select In-Port...</option>
                                    {% for nic in nics %}<option value="{{ nic }}">{{ nic }}</option>{% endfor %}
                                </select>
                            </div>
                            
                            <div class="mb-2">
                                <label class="small text-muted">⬆️ Downstream (转发给从站)</label>
                                <select class="form-select form-select-sm" id="bcMasterIf">
                                    <option value="" disabled selected>Select Out-Port...</option>
                                    {% for nic in nics %}<option value="{{ nic }}">{{ nic }}</option>{% endfor %}
                                </select>
                            </div>
                            <div class="form-text text-danger" style="font-size:0.75rem" id="bcWarn"></div>
                        </div>

                        <hr>
                        <div class="mb-2">
                            <label class="small text-muted">Profile</label>
                            <div class="input-group input-group-sm">
                                <select class="form-select" id="profileSelect" onchange="loadProfileData()"></select>
                                <button type="button" class="btn btn-outline-secondary" onclick="saveProfile()">Save</button>
                            </div>
                        </div>

                        <div class="row g-2 mb-2">
                            <div class="col-4"><label class="small text-muted">Domain</label><input type="number" class="form-control form-control-sm" id="domain"></div>
                            <div class="col-4"><label class="small text-muted">Prio 1</label><input type="number" class="form-control form-control-sm" id="priority1"></div>
                            <div class="col-4"><label class="small text-muted">Prio 2</label><input type="number" class="form-control form-control-sm" id="priority2"></div>
                        </div>
                        <div class="row g-2 mb-2">
                            <div class="col-6"><label class="small text-muted">Sync Int</label><input type="number" class="form-control form-control-sm" id="logSyncInterval"></div>
                            <div class="col-6"><label class="small text-muted">Announce Int</label><input type="number" class="form-control form-control-sm" id="logAnnounceInterval"></div>
                        </div>
                        <div class="row g-2 mb-3">
                            <div class="col-6"><label class="small text-muted">Delay Req</label><input type="number" class="form-control form-control-sm" id="logMinDelayReqInterval"></div>
                            <div class="col-6"><label class="small text-muted">Receipt T/O</label><input type="number" class="form-control form-control-sm" id="announceReceiptTimeout"></div>
                        </div>
                        <div class="d-grid gap-2">
                            <button type="button" onclick="applyConfig()" class="btn btn-primary btn-sm fw-bold">Apply & Restart</button>
                            <button type="button" onclick="stopService()" class="btn btn-danger btn-sm">Stop</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        <div class="col-lg-8">
            <div class="card shadow-sm h-100">
                <div class="card-header d-flex justify-content-between py-2">
                    <span class="fw-bold small">PTP4L Logs</span>
                    <span class="badge bg-secondary" id="logTime">--:--:--</span>
                </div>
                <div class="card-body p-0">
                    <div id="logWindow">Connecting...</div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let profiles = {};
    const FIELDS = ['domain','priority1','priority2','logSyncInterval','logAnnounceInterval','logMinDelayReqInterval','announceReceiptTimeout'];

    function init() {
        fetchProfiles();
        setInterval(updateStatus, 1500);
        setInterval(updateLogs, 3000);
    }

    function toggleMode() {
        const mode = document.getElementById('clockMode').value;
        if(mode === 'BC') {
            document.getElementById('ocPanel').style.display = 'none';
            document.getElementById('bcPanel').style.display = 'block';
        } else {
            document.getElementById('ocPanel').style.display = 'block';
            document.getElementById('bcPanel').style.display = 'none';
        }
    }

    function fetchProfiles() {
        fetch('/api/profiles').then(r=>r.json()).then(data => {
            profiles = data;
            const sel = document.getElementById('profileSelect');
            sel.innerHTML = '<option disabled selected>-- Select --</option>';
            for(let id in data) {
                let opt = document.createElement('option');
                opt.value = id;
                opt.text = data[id].name + (data[id].is_builtin ? "*" : "");
                sel.add(opt);
            }
        });
    }

    function loadProfileData() {
        const pid = document.getElementById('profileSelect').value;
        if(!profiles[pid]) return;
        FIELDS.forEach(f => {
            const el = document.getElementById(f);
            if(el) el.value = profiles[pid][f] || 0;
        });
    }

    function applyConfig() {
        const mode = document.getElementById('clockMode').value;
        const data = { clockMode: mode };
        
        if (mode === 'BC') {
            data.bcSlaveIf = document.getElementById('bcSlaveIf').value;
            data.bcMasterIf = document.getElementById('bcMasterIf').value;
            if(!data.bcSlaveIf || !data.bcMasterIf) { alert("Please select BOTH interfaces for BC mode"); return; }
            if(data.bcSlaveIf === data.bcMasterIf) { alert("BC interfaces must be different!"); return; }
        } else {
            data.interface = document.getElementById('interface').value;
            if(!data.interface) { alert("Select interface"); return; }
        }
        
        if(!confirm(`Apply configuration in ${mode} mode?`)) return;

        FIELDS.forEach(f => {
            const el = document.getElementById(f);
            data[f] = el ? el.value : 0; 
        });
        
        fetch('/api/apply', {
            method: 'POST', 
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        }).then(r=>r.json()).then(res => {
            if(res.status === 'success') alert("✅ Configuration Applied!");
            else alert("❌ Failed: " + res.message);
        });
    }

    function updateStatus() {
        fetch('/api/status').then(r=>r.json()).then(d => {
            const ptpCard = document.getElementById('ptpCard');
            const ptpText = document.getElementById('ptpState');
            
            if(d.ptp4l === 'RUNNING') {
                const state = d.port || "UNKNOWN";
                ptpText.innerText = state;
                document.getElementById('serviceStateDetail').innerText = "Running";
                
                if (state === 'SLAVE') ptpCard.className = 'status-box bg-slave shadow-sm';
                else if (state === 'MASTER') ptpCard.className = 'status-box bg-master shadow-sm';
                else if (state === 'UNCALIBRATED') ptpCard.className = 'status-box bg-init shadow-sm';
                else ptpCard.className = 'status-box bg-running shadow-sm';
            } else {
                ptpCard.className = 'status-box bg-stopped shadow-sm';
                ptpText.innerText = "STOPPED";
                document.getElementById('serviceStateDetail').innerText = "Inactive";
            }

            document.getElementById('offsetVal').innerText = d.offset;
            document.getElementById('gmId').innerText = d.gm || "N/A";
        }).catch(e => {});
    }
    
    // 省略日志和保存逻辑，保持一致...
    function updateLogs() { fetch('/api/logs').then(r=>r.json()).then(d => { const w=document.getElementById('logWindow'); if(w){ w.innerText=d.logs; w.scrollTop=w.scrollHeight; } }); }
    function saveProfile() { let n=prompt("Name:"); if(n){ let c={}; FIELDS.forEach(f=>c[f]=document.getElementById(f).value); fetch('/api/profiles',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({name:n,config:c})}).then(()=>fetchProfiles()); } }
    function stopService() { if(confirm("Stop?")) fetch('/api/stop',{method:'POST'}); }

    init();
</script>
</body>
</html>
