<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PTP Controller v3.2 by Vega Sun</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .status-box { padding: 15px; border-radius: 8px; color: white; height: 100%; display: flex; flex-direction: column; justify-content: center; }
        .bg-running { background-color: #198754; } 
        .bg-stopped { background-color: #dc3545; }
        .bg-slave { background-color: #0d6efd; }
        .bg-master { background-color: #6610f2; }
        .bg-init { background-color: #ffc107; color: black; }
        #logWindow { background-color: #212529; color: #0f0; height: 450px; overflow-y: auto; padding: 10px; font-family: monospace; font-size: 0.8rem; }
    </style>
</head>
<body class="bg-light">
<div class="container-fluid p-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3 class="mb-0">⏱️ PTP4L Controller by Vega Sun <small class="text-muted fs-6">v3.2</small></h3>
        <span class="badge bg-secondary">{{ hostname }}</span>
    </div>
    <div class="row g-3 mb-3">
        <div class="col-md-4">
            <div id="ptpCard" class="status-box bg-stopped shadow-sm">
                <small>Device State</small>
                <div id="ptpState" class="h3 mb-0">STOPPED</div>
                <small id="serviceStateDetail" class="opacity-75">Service Inactive</small>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card h-100 p-3 shadow-sm justify-content-center">
                <small class="text-muted">Offset</small>
                <div id="offsetVal" class="h3 mb-0 text-primary">--</div>
                <small>ns</small>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card h-100 p-3 shadow-sm justify-content-center">
                <small class="text-muted">Grandmaster ID</small>
                <div id="gmId" class="h6 mb-0 text-break font-monospace">Scanning...</div>
            </div>
        </div>
    </div>
    <div class="row g-3">
        <div class="col-lg-4">
            <div class="card shadow-sm">
                <div class="card-header fw-bold">⚙️ Configuration</div>
                <div class="card-body">
                    <form id="configForm">
                        <div class="mb-3">
                            <label class="form-label fw-bold small text-uppercase text-secondary">Clock Mode</label>
                            <select class="form-select" id="clockMode" onchange="toggleMode()">
                                <option value="OC" selected>Ordinary Clock (Single Port)</option>
                                <option value="BC">Boundary Clock (Dual Port)</option>
                            </select>
                        </div>
                        <div id="ocPanel" class="mb-3">
                            <label class="small text-muted">Network Interface</label>
                            <select class="form-select" id="interface">
                                <option value="" disabled selected>-- Select --</option>
                                {% for nic in nics %}<option value="{{ nic }}">{{ nic }}</option>{% endfor %}
                            </select>
                        </div>
                        <div id="bcPanel" class="mb-3 border p-2 rounded bg-white" style="display:none;">
                            <label class="small fw-bold text-primary mb-2 d-block">Boundary Clock Topology</label>
                            <div class="mb-2"><label class="small text-muted">⬇️ Upstream (Slave/In)</label><select class="form-select form-select-sm" id="bcSlaveIf"><option value="" disabled selected>-- Select --</option>{% for nic in nics %}<option value="{{ nic }}">{{ nic }}</option>{% endfor %}</select></div>
                            <div class="mb-2"><label class="small text-muted">⬆️ Downstream (Master/Out)</label><select class="form-select form-select-sm" id="bcMasterIf"><option value="" disabled selected>-- Select --</option>{% for nic in nics %}<option value="{{ nic }}">{{ nic }}</option>{% endfor %}</select></div>
                        </div>
                        <hr>
                        <div class="mb-2"><label class="small text-muted">Profile</label><div class="input-group input-group-sm"><select class="form-select" id="profileSelect" onchange="loadProfileData()"></select><button type="button" class="btn btn-outline-secondary" onclick="saveProfile()">Save</button></div></div>
                        <div class="row g-2 mb-2">
                            <div class="col-4"><label class="small text-muted">Domain</label><input type="number" class="form-control form-control-sm" id="domain"></div>
                            <div class="col-4"><label class="small text-muted">Prio 1</label><input type="number" class="form-control form-control-sm" id="priority1"></div>
                            <div class="col-4"><label class="small text-muted">Prio 2</label><input type="number" class="form-control form-control-sm" id="priority2"></div>
                        </div>
                        <div class="row g-2 mb-2">
                            <div class="col-6"><label class="small text-muted">Sync Int</label><input type="number" class="form-control form-control-sm" id="logSyncInterval"></div>
                            <div class="col-6"><label class="small text-muted">Announce Int</label><input type="number" class="form-control form-control-sm" id="logAnnounceInterval"></div>
                        </div>
                        <div class="row g-2 mb-3">
                            <div class="col-6"><label class="small text-muted">Delay Req</label><input type="number" class="form-control form-control-sm" id="logMinDelayReqInterval"></div>
                            <div class="col-6"><label class="small text-muted">Receipt T/O</label><input type="number" class="form-control form-control-sm" id="announceReceiptTimeout"></div>
                        </div>
                        <div class="d-grid gap-2"><button type="button" onclick="applyConfig()" class="btn btn-primary btn-sm fw-bold">Apply & Restart</button><button type="button" onclick="stopService()" class="btn btn-danger btn-sm">Stop</button></div>
                    </form>
                </div>
            </div>
        </div>
        <div class="col-lg-8">
            <div class="card shadow-sm h-100">
                <div class="card-header d-flex justify-content-between py-2"><span class="fw-bold small">PTP4L Logs</span><span class="badge bg-secondary" id="logTime">--:--:--</span></div>
                <div class="card-body p-0"><div id="logWindow">Connecting...</div></div>
            </div>
        </div>
    </div>
</div>
<script>
    let profiles={}; const FIELDS=['domain','priority1','priority2','logSyncInterval','logAnnounceInterval','logMinDelayReqInterval','announceReceiptTimeout'];
    function init(){ fetchProfiles(); setInterval(updateStatus,1500); setInterval(updateLogs,3000); }
    function toggleMode(){ const m=document.getElementById('clockMode').value; document.getElementById('ocPanel').style.display=(m==='OC'?'block':'none'); document.getElementById('bcPanel').style.display=(m==='BC'?'block':'none'); }
    function fetchProfiles(){ fetch('/api/profiles').then(r=>r.json()).then(d=>{ profiles=d; const s=document.getElementById('profileSelect'); s.innerHTML='<option disabled selected>-- Select --</option>'; for(let i in d){ let o=document.createElement('option'); o.value=i; o.text=d[i].name+(d[i].is_builtin?"*":""); s.add(o); } }); }
    function loadProfileData(){ const p=document.getElementById('profileSelect').value; if(profiles[p]) FIELDS.forEach(f=>{ let el=document.getElementById(f); if(el) el.value=profiles[p][f]||0; }); }
    function applyConfig(){
        const m=document.getElementById('clockMode').value; const d={clockMode:m};
        if(m==='BC'){ d.bcSlaveIf=document.getElementById('bcSlaveIf').value; d.bcMasterIf=document.getElementById('bcMasterIf').value; if(!d.bcSlaveIf||!d.bcMasterIf||d.bcSlaveIf===d.bcMasterIf){ alert("Invalid BC Interface Config"); return; } }
        else{ d.interface=document.getElementById('interface').value; if(!d.interface){ alert("Select Interface"); return; } }
        if(!confirm("Apply & Restart?")) return;
        FIELDS.forEach(f=>{ let el=document.getElementById(f); d[f]=el?el.value:0; });
        fetch('/api/apply',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(d)}).then(r=>r.json()).then(r=>{ if(r.status==='success') alert("✅ Success!"); else alert("❌ "+r.message); }).catch(e=>alert("Error:"+e));
    }
    function updateStatus(){ fetch('/api/status').then(r=>r.json()).then(d=>{
        const c=document.getElementById('ptpCard'), t=document.getElementById('ptpState');
        if(d.ptp4l==='RUNNING'){
            t.innerText=d.port||"UNKNOWN"; document.getElementById('serviceStateDetail').innerText="Running";
            if(d.port==='SLAVE') c.className='status-box bg-slave shadow-sm'; else if(d.port==='MASTER'||d.port==='GRAND_MASTER') c.className='status-box bg-master shadow-sm'; else c.className='status-box bg-running shadow-sm';
        } else { c.className='status-box bg-stopped shadow-sm'; t.innerText="STOPPED"; document.getElementById('serviceStateDetail').innerText="Inactive"; }
        document.getElementById('offsetVal').innerText=d.offset; document.getElementById('gmId').innerText=d.gm||"N/A";
    }).catch(()=>{}); }
    function updateLogs(){ fetch('/api/logs').then(r=>r.json()).then(d=>{ const w=document.getElementById('logWindow'); if(w){ w.innerText=d.logs; w.scrollTop=w.scrollHeight; } }).catch(()=>{}); }
    function saveProfile(){ let n=prompt("Name:"); if(n){ let c={}; FIELDS.forEach(f=>c[f]=document.getElementById(f).value); fetch('/api/profiles',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({name:n,config:c})}).then(()=>fetchProfiles()); } }
    function stopService(){ if(confirm("Stop?")) fetch('/api/stop',{method:'POST'}); }
    init();
</script>
</body>
</html>
